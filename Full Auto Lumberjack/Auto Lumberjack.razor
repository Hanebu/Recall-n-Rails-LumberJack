#Auto Lumberjack by Xyio

# 1. Create organizer 17(default) to move resources to your pack animal
#     or change 'organizer 17' in the script to another number (not suggested)
#     set your organizer's hotbag as your pack animal
#
# 2. The companion script 'WatchAndWait' must accompany this if you would like PK avoidance
#     while your harvester is not swinging.
#
# 3. The companion script 'ResetRails' is required anytime you need to reset the script to the begining.
#
# 4. Will look for a rune in your backpack and then a Runebook
#     Set the default location to a safe place to recall your
#     miner to when full or detected a red.
#
#
# This script uses very few pauses or waits.
# It uses a series of timers to gain very fast PK detection.
#
# 
# <><><><><><><><><><><><><><><><><><><><><>
# ******************************************
# //--------------------------------------//
# //----PASTE RAILS FILE CONTENTS HERE----//


# //-------END RAILS FILE CONTENTS -------//
# //--------------------------------------//
#*******************************************
# <><><><><><><><><><><><><><><><><><><><><>
#
# ----CONFIG BELOW----
#----USE RAILS?--- (0 if off, 1 is on)
setvar useRails 1
#
#
# Should we attempt to defend ourselves from monsters?
setvar useCombatDefense 1
#
#
# Healing method ( 1 for bandages, 2 for magery)
setvar healingMethod 2
#
#
# How long it takes you to apply a bandaid (this will be based on your dex)
setvar bandageTime 12000
#
#
# How long before you can use Magery healing again (should be no less than Gheal cast time)
setvar mageryHealTime 3000
#
#
# Delay before movment attempts
setvar movementDelay 250
#
#
# Variable to make our location
# persist across errors 
setvar xListEntry 0
setvar yListEntry 0
#
#
# See Debugging Messages overhead?
setvar debugScript 0
#
#
# Max time without a system message before the script
# considers it a timeout. (default 13000)
setvar harvestTimeout 13000
#
#
# Max length of time before the script considers 
# heavy lag or a captcha is up. (default 12000)
setvar gumpOrLagTimeout 12000
#
#
# Max time before your tool swing is considered
# timed out. (default 500)
setvar swingTimeout 500
#
# Use Scrolls for recall? ( 1 = yes, 0 = no)
setvar useScrolls 0
#
#
#---- CHECKS TO SEE IF 'firstRun" list exists ----
# if the list exists it coninues on with the old rail position
# and packy dump sequence. If you delete the first run list
# the script will reset your rail, your packy sequence and your system messages.
#
#

if not listexists 'firstRun'
    createlist 'firstRun'
    clearsysmsg
    setvar packyDumps 0
    setvar lastDirection 0
    setvar choppedWood 0
    setvar previousDirection 0
endif

#----------------DO NOT EDIT BELOW THIS LINE-----------------------

if not timerexists '_harvest'
    createtimer '_harvest'
    settimer '_harvest' 99999
endif
if not timerexists '_sysmsg'
    createtimer '_sysmsg'
    settimer '_sysmsg' 99999
endif
if not timerexists '_checkweight'
    createtimer '_checkweight'
    settimer '_checkweight' 99999
endif
if not timerexists '_healbandaid'
    createtimer '_healbandaid'
    settimer '_healbandaid' 99999
endif
if not timerexists '_healmagery'
    createtimer '_healmagery'
    settimer '_healmagery' 99999
endif
if not varexist packyDumps
    setvar packyDumps 0
endif

#Set timers initially to get into while loop.
settimer '_harvest' 0
settimer '_sysmsg' 0
settimer '_checkweight' 0

while timer '_harvest' < harvestTimeout
    if useCombatDefense == 1
        #use Bandaids
        if healingMethod == 1
            if diffhits > 1
                if timer '_healbandaid' < bandageTime
                    #TODO: FINDTYPE FOR BANDAIDS
                    hotkey 'Bandage Self'
                    settimer '_healbandaid' 0
                endif
            endif
        endif
        #use Magery
        if healingMethod == 2
            if diffhits > 15
                if timer '_healmagery' < mageryHealTime
                hotkey 'Smart Heal/Cure Self'
                settimer '_healmagery' 0
            endif
        endif
        #TODO USE DESIRED COMBAT ROTATION
    endif
    if diffweight <= 40
        if timer '_checkweight' < 1000
            overhead "::: You have a full load :::" 15
            overhead "::: Running Organizer :::" 55
                if packyDumps == 4
                    overhead "::: Packy Full Recalling Instead :::" 33     
                    setvar packyDumps 0
                    cast "recall"
                    waitfortarget 3000
                    if findtype 'recall rune' backpack
                        targettype 'recall rune' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'WaitAndWatch'
                    endif
                    if findtype 'Runebook' true
                        targettype 'Runebook' true
                        overhead "::: Recalled Out :::" 15
                        script 'WaitAndWatch'
                    endif
                endif
                if packyDumps == 3
                    overhead "::: Fourth Dump on pack animal :::" 33
                    organizer 17
                    setvar packyDumps 4
                endif
                if packyDumps == 2
                    overhead "::: Third Dump on pack animal :::" 33
                    organizer 17
                    setvar packyDumps 3
                endif
                if packyDumps == 1
                    overhead "::: Second Dump on pack animal :::" 33
                    organizer 17
                    setvar packyDumps 2
                endif
                if packyDumps == 0
                    overhead "::: First Dump on pack animal :::" 33
                    organizer 17
                    setvar packyDumps 1
                endif
            endif
            settimer '_checkweight' 1000
            settimer '_sysmsg' 0
            settimer '_harvest' 0
        endif
        if timer '_checkweight' > 2000
            if diffweight <= 40
                overhead "::: NO PACKIE FOUND :::" 55
                overhead "::: RECALLING NOW :::" 33
                cast "recall"
                waitfortarget 3000
                if findtype 'recall rune' true
                    targettype 'recall rune' backpack
                    overhead "::: Recalled Out :::"
                    script 'WaitAndWatch'
                endif
                if findtype 'Runebook' true
                    targettype 'Runebook' backpack
                    overhead "::: Recalled Out :::"
                    script 'WaitAndWatch'
                endif
            endif
        endif
    endif
    #LOOK FOR PK
    if insysmsg "Now tracking:"
        overhead "::: RED FOUND :::" 55
        overhead "::: RECALLING NOW :::" 33
        cast "recall"
        waitfortarget 3000
        if findtype 'recall rune' backpack
            targettype 'recall rune' backpack
            overhead "::: Recalled Out :::" 15
            script 'WaitAndWatch'
        endif
        if findtype 'Runebook' backpack
            targettype 'Runebook' backpack
            overhead "::: Recalled Out :::" 15
            script 'WaitAndWatch'
        endif
    endif

    #MINE
    if timer '_harvest' < swingTimeout
        if lhandempty
        if not findtype 3908 backpack
                overhead "::: You are out of tools:::"
                cast "recall"
                waitfortarget 3000
                if findtype 'recall rune' backpack
                    targettype 'recall rune' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'WaitAndWatch'
                endif
                if findtype 'Runebook' backpack
                    targettype 'Runebook' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'WaitAndWatch'
                endif
                script "WaitAndWatch"
            endif
            if findtype 3908 backpack as tool
                dclick 'tool'
                overhead ":::equipped new tool:::"
                settimer '_harvest' 0
                settimer '_sysmsg' 0
                wait 1000 #DANGEROUS REMOVE WAIT
            endif
        endif
            if findtype 3908 true
                #overhead "Found a TOOL"
            if diffweight >= 40
                wait 150
                #overhead "USING TOOL"
                hotkey 'Use item in Hand'
                waitfortarget 1000 
                target 'self'
                wait 250
            endif
            #LOOK FOR PK AGAIN INCASE SYSMSG OVERWRITTEN
            if insysmsg "Now tracking:"
                overhead "::: RED FOUND :::" 55
                overhead "::: RECALLING NOW :::" 33
                cast "recall"
                waitfortarget 3000
                if findtype 'recall rune' backpack
                    targettype 'recall rune' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'WaitAndWatch'
                endif
                if findtype 'Runebook' backpack
                    targettype 'Runebook' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'WaitAndWatch'
                endif
            endif
        endif
    endif
    
    #HANDLE RESULTS
    if insysmsg "You can't mine that"
        overhead '::: node empty :::'
        script "WaitAndWatch"
    endif
    
if insysmsg "You do not see any"
    overhead "::: node empty :::"
    if useRails == 1
        #overhead '::: moving :::' 55
        for 12
            if atlist xCoord 0 as x
                setvar xListEntry x
            endif
            if atlist yCoord 0 as y
                setvar yListEntry y
            endif       
            if position xListEntry yListEntry              
                overhead 'at location'                                   
                if list moveList > 0             
                    poplist moveList 'front'
                    poplist xCoord 'front'
                    poplist yCoord 'front'
                else
                    overhead "::: Back to town rail completed :::"
                    cast "recall"
                    waitfortarget 3000
                    if findtype 'recall rune' backpack
                        targettype 'recall rune' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'WaitAndWatch'
                    endif
                    if findtype 'Runebook' backpack
                        targettype 'Runebook' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'WaitAndWatch'
                    endif
                endif
            else            
                if atlist moveList 0 as firstEntry
                    #overhead xListEntry
                    #overhead yListEntry
                    if firstEntry == 1
                        overhead '::: moving north :::' 55
                        walk 'north'
                        wait movementDelay
                    endif
                    if firstEntry == 2
                        overhead '::: moving right :::' 55
                        walk 'right'
                        wait movementDelay
                    endif
                    if firstEntry == 3
                        overhead '::: moving east :::' 55
                        walk 'east'
                        wait movementDelay
                    endif
                    if firstEntry == 4
                        overhead '::: moving down :::' 55
                        walk 'down'
                        wait movementDelay
                    endif
                    if firstEntry == 5
                        overhead '::: moving south :::' 55
                        walk 'south'
                        wait movementDelay
                    endif
                    if firstEntry == 6
                        overhead '::: moving left :::' 55
                        walk 'left'
                        wait movementDelay
                    endif
                    if firstEntry == 7
                        overhead '::: moving west :::' 55
                        walk 'west'
                        wait movementDelay
                    endif
                    if firstEntry == 8
                        overhead '::: moving up :::' 55
                        walk 'up'
                        wait movementDelay
                    endif
                endif
            endif
            settimer '_sysmsg' 0
            settimer '_harvest' 0
            settimer '_checkweight' 0
        endfor
    else
        script "WaitAndWatch"
    endif
endif 
    

    if insysmsg 'Dullwood'
        overhead '::: dullwood :::' 248
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'Shadowwood'
        overhead '::: shadowwood :::' 15
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'Copperwood'
        overhead '::: copperwood :::' 248
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'Bronzewood'
        overhead '::: bronzewood :::' 248
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'Goldenwood'
        overhead '::: goldenwood :::' 55
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'Rosewood'
        overhead '::: rosewood :::' 55
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'Verewood'
        overhead '::: verewood :::' 33
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'Valewood'
        overhead '::: valewood :::' 33
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'Avarwood'
        overhead '::: avarwood :::' 33
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    elseif insysmsg 'logs'
        overhead '::: logs :::' 193
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
    endif
    
    #overhead "Hack"
    if insysmsg "You hack"
        settimer '_harvest' 0
        settimer '_sysmsg' 0
        settimer '_checkweight' 0
        overhead '::: hacked :::'
    endif

    if insysmsg 'recently traveled'
        overhead '::: recently traveled :::'
        settimer '_sysmsg' 0
        script 'WaitAndWatch'
    endif
    
    if insysmsg 'Organize Agent queued'
        overhead '::: Organizer Working :::' 55
        wait 2000 #DANGEROUS WAIT
        settimer '_sysmsg' 0
        settimer '_harvest' 0
    endif
    
    if insysmsg 'World is saving, please wait'
        overhead '::: Waiting for Save :::'
        for 4
            wait 1000
            settimer '_sysmsg' 0
            settimer '_harvest' 0
            settimer 'checkweight' 0
        endfor
    endif
    
    if insysmsg 'Harvesting is not allowed in this area'
        overhead '::: You cannot gather in town :::'
        settimer '_sysmsg' 0
        settimer '_harvest' 0
        #settimer '_checkweight' 0
    endif
    
    if insysmsg 'You broke your axe'
        overhead '::: Your axe is broken :::' 33
        if lhandempty
        if not findtype 3908 backpack
                overhead "::: You are out of tools:::"
                cast "recall"
                waitfortarget 3000
                if findtype 'recall rune' backpack
                    targettype 'recall rune' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'WaitAndWatch'
                endif
                if findtype 'Runebook' backpack
                    targettype 'Runebook' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'WaitAndWatch'
                endif
                script "WaitAndWatch"
            endif
            if findtype 3908 backpack as tool
                dclick 'tool'
                overhead ":::equipped new tool:::"
                settimer '_harvest' 0
                settimer '_sysmsg' 0
                wait 1000
            endif
        endif
        settimer '_sysmsg' 0
        settimer '_harvest' 0
        settimer '_checkweight' 0
    endif
    
    
    if timer '_sysmsg' > gumpOrLagTimeout
        overhead "::: GUMP or LAG :::" 33
        overhead "::: Replay Script :::" 55
        script "WaitAndWatch"
    endif
endwhile
