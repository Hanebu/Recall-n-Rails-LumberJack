#Start: 1751, 1946 (PrevaliaSouth)
#Auto Lumberjack by Xyio
# 1. Create organizer 17(default) to move resources to your pack animal
#     or change 'organizer 17' in the script to another number (not suggested)
#     set your organizer's hotbag as your pack animal
#
# 2. The companion script 'WatchAndWait' must accompany this if you would like PK avoidance
#     while your harvester is not swinging.
#
# 3. The companion script 'ResetRails' is required anytime you need to reset the script to the begining.
#
# 4. Will look for a rune in your backpack and then a Runebook
#     Set the default location to a safe place to recall your
#     miner to when full or detected a red.
#
#
# This script uses very few pauses or waits.
# It uses a series of timers to gain very fast PK detection.
#
#----USE RAILS?--- (0 if off, 1 is on)
setvar! useRails 1
#
#
# Delay before movment attempts
setvar! movementDelay 300
#
#
# Variable to make our location
# persist across errors 
setvar! xListEntry 0
setvar! yListEntry 0
#
#
# Max time without a system message before the script
# considers it a timeout. (default 13000)
setvar! harvestTimeout 13000
#
#
# Max length of time before the script considers 
# heavy lag or a captcha is up. (default 12000)
setvar! gumpOrLagTimeout 12000
#
#
# Max time before your tool swing is considered
# timed out. (default 500)
setvar! swingTimeout 400
#
#
#---- CHECKS TO SEE IF 'firstRun" list exists ----
# if the list exists it coninues on with the old rail position
# and packy dump sequence. If you delete the first run list
# the script will reset your rail, your packy sequence and your system messages.

if not listexists 'firstRun'
    createlist 'firstRun'
    clearsysmsg
endif

#----------------DO NOT EDIT BELOW THIS LINE-----------------------

if not timerexists '_harvest'
    createtimer '_harvest'
    settimer '_harvest' 99999
endif
if not timerexists '_checkweight'
    createtimer '_checkweight'
    settimer '_checkweight' 99999
endif
if not timerexists '_healbandaid'
    createtimer '_healbandaid'
    settimer '_healbandaid' 99999
endif
if not timerexists '_healmagery'
    createtimer '_healmagery'
    settimer '_healmagery' 99999
endif
if not timerexists '_equippedToolLast'
    createtimer '_equippedToolLast'
    settimer '_equippedToolLast' 99999
endif
if not timerexists '_recastElemental'
    createtimer '_recastElemental'
    settimer '_recastElemental' 999999
endif
if not timerexists '_eleCastTimer'
    createtimer '_eleCasttimer'
    settimer '_eleCastTimer' 99999
endif
if not varexist packyDumps
    setvar packyDumps 0
endif

setvar isGuarding 0

#Set timers initially to get into while loop.
settimer '_harvest' 0
settimer '_checkweight' 0

while timer '_harvest' < harvestTimeout
   if 'useSummons' == 1
        #if we don't have an elemental we cast one.
        while followers < 2
            if counttype 'Blood Moss' 'backpack' > 10 and counttype 'Black Pearl%s%' 'backpack' > 10 and counttype 'Mandrake Root%s%' 'backpack' > 10 and counttype "Spider's Silk" 'backpack' > 10
                if mana > 40
                    if timer '_eleCastTimer' > 7000
                        setvar isGuarding 0
                        hotkey "Water Elemental"
                        settimer '_eleCastTimer' 0
                        settimer '_harvest' 0
                    endif
                endif
                if insysmsg "Now tracking:"
                    overhead "::: RED FOUND :::" 55
                    overhead "::: RECALLING NOW :::" 33
                    cast "recall"
                    waitfortarget 3000
                     if findtype 'Runebook' backpack
                        targettype 'Runebook' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'BankController'
                    endif
                    if findtype 'recall rune' backpack
                        targettype 'recall rune' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'BankController'
                    endif
                endif
            else
                overhead "::: out of regs :::" 44
                overhead "::: recalling now :::" 44
                cast "recall"
                waitfortarget 3000
                 if findtype 'Runebook' backpack
                    targettype 'Runebook' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'BankController'
                endif
                if findtype 'recall rune' backpack
                    targettype 'recall rune' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'BankController'
                endif
            endif
            settimer '_harvest' 0
        endwhile
        settimer '_recastElemental' 0
        if timer '_recastElemental' > 300000
            while summons < 4
                if counttype 'Blood Moss' 'backpack' > 10 and counttype 'Black Pearl%s%' 'backpack' > 10 and counttype 'Mandrake Root%s%' 'backpack' > 10 and counttype "Spider's Silk" 'backpack' > 10
                    if mana > 40 and timer '_eleCastTimer' > 7000
                        setvar isGuarding 0
                        hotkey "Water Elemental"
                        settimer '_eleCastTimer' 0
                        settimer '_harvest' 0
                     endif
                     if insysmsg "Now tracking:"
                        overhead "::: RED FOUND :::" 55
                        overhead "::: RECALLING NOW :::" 33
                        cast "recall"
                        waitfortarget 3000
                         if findtype 'Runebook' backpack
                            targettype 'Runebook' backpack
                            overhead "::: Recalled Out :::" 15
                            script 'BankController'
                        endif
                        if findtype 'recall rune' backpack
                            targettype 'recall rune' backpack
                            overhead "::: Recalled Out :::" 15
                            script 'BankController'
                        endif
                    endif
                else
                    overhead "::: out of regs :::" 44
                    overhead "::: recalling now :::" 44
                    cast "recall"
                    waitfortarget 3000
                     if findtype 'Runebook' backpack
                        targettype 'Runebook' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'BankController'
                    endif
                    if findtype 'recall rune' backpack
                        targettype 'recall rune' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'BankController'
                    endif
                endif  
            endwhile
        endif
        if isGuarding == 0
            say "All Guard Me"
            setvar isGuarding 1
        endif
    endif
    
    if insysmsg 'You broke your axe'
        overhead '::: Your axe is broken :::'
        wait 1000
        if lhandempty
            setvar! handled 1
            settimer '_harvest' 0
            settimer '_checkweight' 0
        endif
    endif 
    if diffweight <= 40
        overhead "::: pack is full :::" 33
        cast "recall"
        waitfortarget 3000
        if findtype 'Runebook' true
            targettype 'Runebook' backpack
            overhead "::: Recalled Out :::"
            script 'BankController'
        endif
        if findtype 'recall rune' true
            targettype 'recall rune' backpack
            overhead "::: Recalled Out :::"
            script 'BankController'
        endif
    endif
    
    #MINE
    if timer '_harvest' < swingTimeout
        #clearsysmsg
        setvar! handled 0
        if lhandempty
            if not findtype 3908 backpack
                overhead "::: You are out of tools:::"
                settimer '_harvest' 2000
                cast "recall"
                waitfortarget 3000                
                if findtype 'Runebook' backpack
                    targettype 'Runebook' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'BankController'
                endif
                if findtype 'recall rune' backpack
                    targettype 'recall rune' backpack
                    overhead "::: Recalled Out :::" 15
                    script 'BankController'
                endif
                script "BankController"
            endif
            if findtype 3908 backpack as tool
                if timer '_equippedToolLast' > 3000
                    dclick 'tool'
                    overhead ":::equipped new tool:::"
                    settimer '_equippedToolLast' 0
                    wait 500
                    settimer '_harvest' 0
                    setvar!  handled 1
                endif
            endif                    
        elseif diffweight >= 40
            wait 150
            #overhead "USING TOOL"
            hotkey 'Use item in Hand'
            waitfortarget 6000 
            target 'self'
            wait 250
        else
            overhead "Too Heavy and Dump Failed"
        endif
    endif
    
    #HANDLE RESULTS
    while handled == 0
        #Check for PK while in this loop!
        if insysmsg "Now tracking:"
            overhead "::: RED FOUND :::" 55
            overhead "::: RECALLING NOW :::" 33
            cast "recall"
            waitfortarget 3000
             if findtype 'Runebook' backpack
                targettype 'Runebook' backpack
                overhead "::: Recalled Out :::" 15
                script 'BankController'
            endif
            if findtype 'recall rune' backpack
                targettype 'recall rune' backpack
                overhead "::: Recalled Out :::" 15
                script 'BankController'
            endif
        endif        
        if insysmsg "You can't mine that"
            overhead '::: node empty :::'
            script "WaitAndWatch"
            setvar! handled 1
        elseif insysmsg "You do not see any"
            overhead "::: node empty :::"
            if useRails == 1
                #overhead '::: moving :::' 55
                for 12
                    if atlist xCoord 0 as x
                        @setvar! xListEntry x
                    endif
                    if atlist yCoord 0 as y
                        @setvar! yListEntry y
                    endif       
                    if position xListEntry yListEntry              
                        overhead 'at location'                                   
                        if list moveList > 0             
                            poplist moveList 'front'
                            poplist xCoord 'front'
                            poplist yCoord 'front'
                        else
                            overhead "::: Back to town rail completed :::"
                            cast "recall"
                            waitfortarget 3000
                            if findtype 'Runebook' backpack
                                targettype 'Runebook' backpack
                                overhead "::: Recalled Out :::" 15
                                script 'BankController'
                            endif
                            if findtype 'recall rune' backpack
                                targettype 'recall rune' backpack
                                overhead "::: Recalled Out :::" 15
                                script 'BankController'
                            endif                         
                        endif
                    else            
                        if atlist moveList 0 as firstEntry
                            #overhead xListEntry
                            #overhead yListEntry
                            if firstEntry == 1
                                overhead '::: moving north :::' 55
                                walk 'north'
                                wait movementDelay
                            endif
                            if firstEntry == 2
                                overhead '::: moving right :::' 55
                                walk 'right'
                                wait movementDelay
                            endif
                            if firstEntry == 3
                                overhead '::: moving east :::' 55
                                walk 'east'
                                wait movementDelay
                            endif
                            if firstEntry == 4
                                overhead '::: moving down :::' 55
                                walk 'down'
                                wait movementDelay
                            endif
                            if firstEntry == 5
                                overhead '::: moving south :::' 55
                                walk 'south'
                                wait movementDelay
                            endif
                            if firstEntry == 6
                                overhead '::: moving left :::' 55
                                walk 'left'
                                wait movementDelay
                            endif
                            if firstEntry == 7
                                overhead '::: moving west :::' 55
                                walk 'west'
                                wait movementDelay
                            endif
                            if firstEntry == 8
                                overhead '::: moving up :::' 55
                                walk 'up'
                                wait movementDelay
                            endif
                        endif
                    endif
                    settimer '_harvest' 0
                    settimer '_checkweight' 0
                    setvar! handled 1
                endfor
            else
                script "WaitAndWatch"
            endif
        elseif insysmsg 'Dullwood'
            overhead '::: dullwood :::' 248
            settimer '_harvest' 0
            settimer '_checkweight' 0          
            setvar! handled 1
        elseif insysmsg 'Shadowwood'
            overhead '::: shadowwood :::' 15
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg 'Copperwood'
            overhead '::: copperwood :::' 248
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg 'Bronzewood'
            overhead '::: bronzewood :::' 248
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg 'Goldenwood'
            overhead '::: goldenwood :::' 55
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg 'Rosewood'
            overhead '::: rosewood :::' 55
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg 'Verewood'
            overhead '::: verewood :::' 33
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg 'Valewood'
            overhead '::: valewood :::' 33
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg 'Avarwood'
            overhead '::: avarwood :::' 33
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg 'logs'
            overhead '::: logs :::' 193
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif insysmsg "You hack"
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
            overhead '::: hacked :::'
        elseif insysmsg 'recently traveled'
            overhead '::: recently traveled :::'
            script 'BankController'
        elseif insysmsg 'Organize Agent queued'
            overhead '::: Organizer Working :::' 55
            while queued
                endwhile
            settimer '_harvest' 0
            setvar! handled 1
        elseif insysmsg 'World is saving, please wait'
            overhead '::: Waiting for Save :::'
            for 5
                wait 1000
                settimer '_harvest' 0
                settimer 'checkweight' 0
            endfor
        elseif insysmsg 'Harvesting is not allowed in this area'
            overhead '::: You cannot gather in town :::' 44
            overhead "::: RECALLING NOW :::" 44
            cast "recall"
            waitfortarget 3000
            if findtype 'Runebook' backpack
                targettype 'Runebook' backpack
                overhead "::: Recalled Out :::" 15
                script 'BankController'
            endif
            if findtype 'recall rune' backpack
                targettype 'recall rune' backpack
                overhead "::: Recalled Out :::" 15
                script 'BankController'
            endif
            #settimer '_harvest' 0
            #settimer '_checkweight' 0
            #setvar! handled 1
        elseif insysmsg 'You broke your axe'
            overhead '::: Your axe is broken :::'
            if lhandempty
                wait 1000
                setvar! handled 1
                settimer '_harvest' 0
                settimer '_checkweight' 0
            endif
        elseif insysmsg 'equipped for any serious chopping'
            overhead '::: Whoops where did your axe go!? :::'
            settimer '_harvest' 0
            settimer '_checkweight' 0
            setvar! handled 1
        elseif timer '_harvest' > gumpOrLagTimeout
            overhead "::: Entering Watch Mode :::" 55
            while not insysmsg 'captcha successful'
                #Check for PK while in this loop!
                if insysmsg "Now tracking:"
                    overhead "::: RED FOUND :::" 55
                    overhead "::: RECALLING NOW :::" 33
                    cast "recall"
                    waitfortarget 3000
                    if findtype 'Runebook' backpack
                        targettype 'Runebook' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'BankController'
                    endif
                    if findtype 'recall rune' backpack
                        targettype 'recall rune' backpack
                        overhead "::: Recalled Out :::" 15
                        script 'BankController'
                    endif
                endif
            endwhile
            setvar! handled 1
            settimer '_harvest' 0
            settimer '_checkweight' 0
        endif
    endwhile
endwhile   